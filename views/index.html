<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro de Registros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>Bem-vindo ao Sistema de Registro</h1>
    <h2>Cadastro de Registros</h2>
  </div>
  <div class="box">
    <p>Preencha o formulário abaixo para cadastrar um novo registro.</p>

    <form id="formRegistro">
      <input type="text" id="nome" placeholder="Nome" required />
      <input type="text" id="telefone" placeholder="Telefone" />
      <input type="text" id="cpf" placeholder="CPF" />
      <input type="text" id="endereco" placeholder="Endereço" />
      <input type="text" id="servico" placeholder="Serviço" required />
      <input type="text" id="descricao" placeholder="Descrição" />
      <input type="date" id="dataEntrega" placeholder="Data de Entrega" />
      
      <input type="search" id="status" list="statusOptions" placeholder="Status" />
      <datalist id="statusOptions">
        <option value="Pendente">
        <option value="Em Andamento">
        <option value="Concluído">
        <option value="Cancelado">
      </datalist>

      <button type="submit">Cadastrar</button>
    </form>

    <h2>Registros Cadastrados</h2>
    <ul id="listaRegistros"></ul>
  </div>

  <script>
    const form = document.getElementById('formRegistro');
    const lista = document.getElementById('listaRegistros');

    async function carregarRegistros() {
      lista.innerHTML = '<li>Carregando...</li>';
      try {
        const res = await fetch('http://localhost:3000/registros');
        if (!res.ok) throw new Error('Falha ao buscar registros');
        const registros = await res.json();

        if (registros.length === 0) {
          lista.innerHTML = '<li>Nenhum registro encontrado.</li>';
          return;
        }

        lista.innerHTML = '';
        registros.forEach(registro => {
          const li = document.createElement('li');
          li.textContent = `${registro.nome} - ${registro.servico} - Status: ${registro.status || 'N/A'}`;

          // Botão deletar
          const btnDeletar = document.createElement('button');
          btnDeletar.textContent = 'Deletar';
          btnDeletar.onclick = async () => {
            if (confirm(`Deseja realmente deletar o registro de ${registro.nome}?`)) {
              try {
                const resDel = await fetch(`http://localhost:3000/registros/${registro._id}`, { method: 'DELETE' });
                if (!resDel.ok) throw new Error('Erro ao deletar');
                carregarRegistros();
              } catch (err) {
                alert('Erro ao deletar registro');
                console.error(err);
              }
            }
          };
          li.appendChild(btnDeletar);
          lista.appendChild(li);
        });
      } catch (err) {
        lista.innerHTML = '<li>Erro ao carregar registros.</li>';
        console.error(err);
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const dados = {
        nome: form.nome.value.trim(),
        telefone: form.telefone.value.trim(),
        cpf: form.cpf.value.trim(),
        endereco: form.endereco.value.trim(),
        servico: form.servico.value.trim(),
        descricao: form.descricao.value.trim(),
        dataEntrega: form.dataEntrega.value,
        status: document.getElementById('status').value.trim(),
      };

      try {
        const res = await fetch('http://localhost:3000/registros', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados),
        });

        if (!res.ok) {
          const erro = await res.json();
          alert(`Erro: ${erro.error}`);
          return;
        }

        form.reset();
        carregarRegistros();
      } catch (err) {
        alert('Erro ao cadastrar registro');
        console.error(err);
      }
    });

    carregarRegistros();
  </script>
</body>
</html>
