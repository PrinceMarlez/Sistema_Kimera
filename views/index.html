<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Cadastro de Registros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <h1>Bem-vindo ao Sistema de Registro</h1>
    <h1>Cadastro de Registros</h1>
  </div>

  <div class="box">
    <p>Preencha o formulário abaixo para cadastrar um novo registro.</p>

    <form id="formRegistro">
      <input type="text" id="nome" placeholder="Nome" required />
      <input type="text" id="telefone" placeholder="Telefone" />
      <input type="text" id="cpf" placeholder="CPF" />
      <input type="text" id="endereco" placeholder="Endereço" />
      <input type="text" id="servico" placeholder="Serviço" required />
      <input type="text" id="descricao" placeholder="Descrição" />
      <input type="date" id="dataEntrega" placeholder="Data de Entrega" />
      
      <input type="search" id="status" list="statusOptions" placeholder="Status" />
      <datalist id="statusOptions">
        <option value="Pendente">
        <option value="Em Andamento">
        <option value="Concluído">
        <option value="Cancelado">
      </datalist>

      <button type="submit">Cadastrar</button>
    </form>

    <hr>

    <div class="search-container">
      <input type="text" id="inputPesquisa" placeholder="Pesquisar por nome ou CPF" />
      <button id="btnPesquisar">Pesquisar</button>
      <button id="btnLimpar">Limpar</button>
    </div>

    <h2>Registros Cadastrados</h2>
    <ul id="listaRegistros"></ul>
  </div>

  <script>
    const form = document.getElementById('formRegistro');
    const lista = document.getElementById('listaRegistros');
    const inputPesquisa = document.getElementById('inputPesquisa');
    const btnPesquisar = document.getElementById('btnPesquisar');
    const btnLimpar = document.getElementById('btnLimpar');

    // Formata data para DD/MM/AAAA
    function formatarData(dataISO) {
      if (!dataISO) return 'N/A';
      const data = new Date(dataISO);
      const dia = String(data.getDate()).padStart(2, '0');
      const mes = String(data.getMonth() + 1).padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    // Carrega os registros da API, com busca opcional
    async function carregarRegistros(pesquisa = '') {
      lista.innerHTML = '<li>Carregando...</li>';
      try {
        let url = 'http://localhost:3000/registros';
        if (pesquisa) {
          // Envia nome ou cpf como query para /search
          url = `http://localhost:3000/registros/search?nome=${encodeURIComponent(pesquisa)}&cpf=${encodeURIComponent(pesquisa)}`;
        }

        const res = await fetch(url);
        const registros = await res.json();

        if (registros.length === 0) {
          lista.innerHTML = '<li>Nenhum registro encontrado.</li>';
          return;
        }

        lista.innerHTML = '';
        registros.forEach(registro => {
          const li = document.createElement('li');
          li.textContent = 
            `${registro.nome} | CPF: ${registro.cpf || 'N/A'} | Serviço: ${registro.servico} | Status: ${registro.status || 'N/A'} | Data de Entrega: ${formatarData(registro.dataEntrega)}`;

          // Botão deletar
          const btnDeletar = document.createElement('button');
          btnDeletar.textContent = 'Deletar';
          btnDeletar.onclick = async () => {
            if (confirm(`Deseja realmente deletar o registro de ${registro.nome}?`)) {
              try {
                const resDel = await fetch(`http://localhost:3000/registros/${registro._id}`, { method: 'DELETE' });
                if (resDel.ok) {
                  carregarRegistros(pesquisa);
                } else {
                  alert('Erro ao deletar registro');
                }
              } catch (err) {
                alert('Erro na requisição de deletar');
                console.error(err);
              }
            }
          };

          li.appendChild(btnDeletar);
          lista.appendChild(li);
        });
      } catch (err) {
        lista.innerHTML = '<li>Erro ao carregar registros.</li>';
        console.error(err);
      }
    }

    // Submit do formulário
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const dados = {
        nome: form.nome.value,
        telefone: form.telefone.value,
        cpf: form.cpf.value,
        endereco: form.endereco.value,
        servico: form.servico.value,
        descricao: form.descricao.value,
        dataEntrega: form.dataEntrega.value,
        status: document.getElementById('status').value,
      };

      try {
        const res = await fetch('http://localhost:3000/registros', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados),
        });

        if (!res.ok) {
          const erro = await res.json();
          alert(`Erro: ${erro.error}`);
          return;
        }

        form.reset();
        carregarRegistros();
      } catch (err) {
        console.error(err);
      }
    });

    // Botão pesquisar
    btnPesquisar.addEventListener('click', () => {
      const pesquisa = inputPesquisa.value.trim();
      carregarRegistros(pesquisa);
    });

    // Botão limpar
    btnLimpar.addEventListener('click', () => {
      inputPesquisa.value = '';
      carregarRegistros();
    });

    // Carrega todos ao iniciar
    carregarRegistros();
  </script>
</body>
</html>
